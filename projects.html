<!-- projects.html (modern v3) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Projects — Dominic Vicchiollo</title>
  <meta name="description" content="Projects and case studies by Dominic Vicchiollo." />
  <link rel="canonical" href="./projects.html" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet" />
  <link rel="icon" href="assets/favicon.svg" type="image/svg+xml" />
  <link rel="stylesheet" href="assets/css/style.css?v=40" />
  <!-- highlight.js for SQL display -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>

  <style>
    :root{
      --bg:#0b1020;
      --surface:#0f1630;
      --card:#121a31;
      --border:#1c2442;
      --muted:#a7b0c0;
      --text:#e9eef8;
      --accent:#7c9cff;
      --accent-2:#22d3ee;
      --radius:18px;
      --shadow:0 24px 80px rgba(0,0,0,.45);
      --container:1600px;
    }
    html,body{background:var(--bg); color:var(--text); font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol";}
    .container{max-width:var(--container); margin:0 auto; padding:0 24px;}
    .page-hero{padding:56px 0 24px;}
    .page-title{font-family:"Space Grotesk", Inter, sans-serif; font-size:clamp(32px,4vw,56px); margin:0 0 12px;}
    .page-kicker{color:var(--muted); max-width:60ch; margin:0;}
    /* layout */
    .projects-layout{display:grid; grid-template-columns: 280px 1fr; gap:24px; align-items:start;}
    @media (max-width: 980px){ .projects-layout{ grid-template-columns: 1fr; } }
    /* filters */
    .filters{position:sticky; top:24px;}
    .filters-inner{background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:16px;}
    .filter-title{margin:.75rem 0 .25rem;}
    .chips{display:flex; flex-wrap:wrap; gap:.5rem; }
    .chip{padding:.45rem .75rem; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.03); cursor:pointer; font-weight:500;}
    .chip[aria-pressed="true"]{ background: rgba(124,156,255,.18); border-color: rgba(124,156,255,.55); }
    .checkbox{display:flex; gap:.5rem; align-items:center; margin-top:.5rem;}
    /* grid cards */
    .grid{display:grid; gap:20px; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.00)), var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); display:flex; flex-direction:column; transition:transform .2s ease, border-color .2s ease; }
    .card:hover{ transform: translateY(-2px); border-color:#2b3a6e; }
    .card-cover{width:100%; height:180px; object-fit:cover; display:block;}
    .card-body{padding:16px; display:grid; gap:8px;}
    .card-title{margin:0; font-size:1.2rem;}
    .card-sub{margin:0; color:var(--muted);}
    .card-desc{margin:0; color:#cfd6e6;}
    .role-badge{ align-self:start; display:inline-flex; gap:.4rem; padding:.25rem .55rem; border:1px solid rgba(34,211,238,.4); background:rgba(34,211,238,.12); border-radius:999px; font-size:.8rem; }
    .role-badge::before{content:"Role"; opacity:.75; font-variant:all-small-caps; letter-spacing:.05em;}
    .meta-tags{display:flex; gap:.4rem; flex-wrap:wrap;}
    .meta-tag{font-size:.75rem; padding:.25rem .5rem; border-radius:999px; border:1px solid var(--border);}
    .metric-chip{font-size:.75rem; padding:.35rem .55rem; border-radius:10px; border:1px dashed var(--border);}
    .card-actions{display:flex; gap:.5rem; flex-wrap:wrap; margin-top:4px;}
    .btn{padding:.55rem .8rem; border-radius:10px; border:1px solid var(--border); background:rgba(255,255,255,.04); color:var(--text); cursor:pointer;}
    .btn.ghost{background:transparent;}
    .btn.secondary{background:rgba(255,255,255,.06);}
    /* quick row */
    .chips-row{display:flex; gap:.5rem; flex-wrap:wrap; margin: 6px 0 14px;}
    /* modern detail overlay */
    .overlay{position:fixed; inset:0; z-index:60; display:none; background:rgba(7,10,22,.72); backdrop-filter: blur(8px);}
    .overlay[aria-hidden="false"]{display:block;}
    .overlay-inner{max-width:var(--container); margin:24px auto; height: calc(100vh - 48px); border-radius:24px; border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.008)), var(--surface); box-shadow: var(--shadow); display:grid; grid-template-rows:auto 1fr;}
    .overlay-header{display:flex; align-items:center; justify-content:space-between; padding:14px 18px; border-bottom:1px solid var(--border);}
    .overlay-title{display:flex; align-items:center; gap:12px;}
    .close{width:36px; height:36px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text); cursor:pointer;}
    .detail-split{display:grid; grid-template-columns: minmax(560px, 1fr) 1fr; gap:22px; padding:18px; overflow:hidden;}
    @media (max-width:1200px){ .detail-split{ grid-template-columns: 1fr; } }
    /* left workbench */
    .workbench{height:100%; background: var(--card); border:1px solid var(--border); border-radius:18px; overflow:hidden; display:flex; flex-direction:column;}
    .wb-tabs{display:flex; gap:8px; padding:10px; border-bottom:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.0));}
    .tab{padding:.45rem .8rem; border-radius:999px; border:1px solid var(--border); background:transparent; cursor:pointer; font-weight:600;}
    .tab[aria-selected="true"]{ background: rgba(124,156,255,.18); border-color: rgba(124,156,255,.55); }
    .wb-stage{position:relative; flex:1; overflow:auto;}
    .wb-stage iframe{border:0; width:100%; height:100%; background:#0c0f1e;}
    pre.code{margin:0; padding:18px; min-height:100%;}
    /* right details */
    .details{height:100%; overflow:auto; display:grid; gap:14px;}
    .kicker{color:var(--muted); margin:0;}
    .title{font-family:"Space Grotesk"; font-size:clamp(28px,3vw,40px); margin:.1rem 0;}
    .subtitle{color:#cfd6e6; font-weight:500; margin:0;}
    .desc{color:#dfe5f3; line-height:1.6; margin:.5rem 0 0;}
    .info-grid{display:grid; grid-template-columns: 1fr 1fr; gap:10px;}
    .info-card{border:1px solid var(--border); background:var(--card); border-radius:14px; padding:10px 12px;}
    .info-title{color:var(--muted); font-size:.85rem; margin:0 0 6px;}
    .pill-row{display:flex; flex-wrap:wrap; gap:.4rem;}
    .pill{font-size:.8rem; padding:.25rem .6rem; border-radius:999px; border:1px solid var(--border); background:rgba(255,255,255,.02);}
    .highlights{margin:4px 0 0; padding-left:1.1rem;}
    .metrics{display:grid; grid-template-columns: repeat(auto-fill, minmax(160px,1fr)); gap:10px;}
    .metric{border:1px solid var(--border); background:var(--card); border-radius:12px; padding:.6rem .7rem;}
    .metric-label{color:var(--muted); font-size:.85rem; margin:0;}
    .metric-value{font-weight:700; font-size:1.05rem; margin-top:.15rem;}
    .links{display:flex; gap:.6rem; flex-wrap:wrap; margin-top:.2rem;}
  </style>
</head>
<body>
  <!-- Site header + nav -->
  <header class="site-header" data-parallax>
    <div class="container header-inner">
      <a class="brand" href="index.html" aria-label="Home">
        <span class="brand-mark">DV</span>
        <span class="brand-text">Dominic Vicchiollo</span>
      </a>

      <button class="nav-toggle" aria-controls="site-nav" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="bar"></span><span class="bar"></span><span class="bar"></span>
      </button>

      <nav id="site-nav" class="site-nav" aria-label="Primary">
        <a href="index.html" class="nav-link">Home</a>
        <a href="projects.html" class="nav-link is-active">Projects</a>
        <a href="domguardianai.html" class="nav-link">DomGuardianAI</a>
      </nav>
    </div>

    <!-- Page heading -->
    <div class="container page-hero">
      <h1 class="page-title">Projects</h1>
      <p class="page-kicker">A showcase of platform builds, SQL craftsmanship, analytics, and architecture—fast to skim, easy to dive deep.</p>
    </div>
  </header>

  <main id="projects" class="section">
    <div class="container projects-layout">
      <!-- Sidebar: filters -->
      <aside class="filters" aria-labelledby="filters-title">
        <div class="filters-inner">
          <div class="filters-head">
            <h2 id="filters-title">Filters</h2>
            <button class="btn ghost small clear-filters" title="Clear all filters">Clear</button>
          </div>

          <div class="filter-group">
            <h3 class="filter-title">Tags</h3>
            <div id="filter-tags" class="chips" role="group" aria-label="Filter by tags"></div>
          </div>

          <div class="filter-group">
            <h3 class="filter-title">Tech</h3>
            <div id="filter-tech" class="chips" role="group" aria-label="Filter by tech"></div>
          </div>

          <div class="filter-group">
            <label class="checkbox">
              <input id="filter-featured" type="checkbox" />
              <span>Featured only</span>
            </label>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <section class="projects-content" aria-live="polite">
        <!-- Quick filters row -->
        <div class="chips-row" id="quick-chips"></div>

        <!-- Grid view -->
        <div id="view-grid" class="view is-active" data-view="grid" aria-label="Grid view"></div>

        <!-- Empty state -->
        <div id="empty" class="empty" hidden>
          <div class="empty-card">
            <h3>No projects match your filters</h3>
            <p>Try removing a few filters.</p>
            <button class="btn clear-filters">Reset filters</button>
          </div>
        </div>

        <!-- Back-to-top + clear buttons -->
        <div class="float-actions">
          <button class="fab" id="btn-top" title="Back to top">↑</button>
          <button class="fab ghost" id="btn-clear" title="Clear filters">⟲</button>
        </div>
      </section>
    </div>
  </main>

  <!-- NEW: Full-canvas detail overlay (no carousel) -->
  <section id="detail-overlay" class="overlay" aria-hidden="true">
    <div class="overlay-inner">
      <div class="overlay-header">
        <div class="overlay-title">
          <span id="detail-kicker" class="kicker"></span>
          <strong id="detail-title" class="title"></strong>
        </div>
        <button class="close" id="detail-close" aria-label="Close">✕</button>
      </div>

      <div class="detail-split">
        <!-- left: workbench with tabs -->
        <div class="workbench">
          <div class="wb-tabs" id="wb-tabs"></div>
          <div class="wb-stage" id="wb-stage"></div>
        </div>

        <!-- right: details -->
        <div class="details">
          <h2 id="d-title" class="title" style="display:none;"></h2>
          <p id="d-sub" class="subtitle"></p>
          <p id="d-desc" class="desc"></p>

          <div class="info-grid">
            <div class="info-card">
              <p class="info-title">Role</p>
              <div id="d-role" class="pill-row"></div>
            </div>
            <div class="info-card">
              <p class="info-title">Tech</p>
              <div id="d-tech" class="pill-row"></div>
            </div>
            <div class="info-card">
              <p class="info-title">Tags</p>
              <div id="d-tags" class="pill-row"></div>
            </div>
            <div class="info-card">
              <p class="info-title">Actions</p>
              <div id="d-links" class="links"></div>
            </div>
          </div>

          <div>
            <p class="info-title" style="margin:.2rem 0 .4rem;">Highlights</p>
            <ul id="d-highlights" class="highlights"></ul>
          </div>

          <div>
            <p class="info-title" style="margin:.2rem 0 .4rem;">Metrics</p>
            <div id="d-metrics" class="metrics"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- No-script fallback -->
  <noscript>
    <section class="container" style="padding:1.5rem 0;">
      <h2>Projects (basic list)</h2>
      <ul>
        <li>Inventory Audit Journal — T-SQL, SQL Agent, Audit</li>
        <li>365-Day Product Sales — Window Logic, KPIs, Performance</li>
        <li>Price Matrix & Replacement Cost — Costing, Margin, ETL</li>
      </ul>
    </section>
  </noscript>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container footer-inner">
      <p>© <span id="year"></span> Dominic Vicchiollo</p>
      <div class="social">
        <a href="https://github.com/domvicc" target="_blank" rel="noopener">GitHub</a>
        <a href="https://www.linkedin.com/in/dominicvicchiollo" target="_blank" rel="noopener">LinkedIn</a>
        <a href="mailto:dvicchiollo@gmail.com">Email</a>
      </div>
    </div>
  </footer>

  <!-- Embedded projects data -->
  <script type="application/json" id="projects-data">
  [
    {
      "id": "inventory-audit-journal",
      "title": "Inventory Audit Journal",
      "subtitle": "Reconciling perpetual vs G/L with staged audit layers",
      "description": "Large scripted job creating staging and analysis tables to reconcile perpetual vs G/L, rebate variance, and SPA claim health with repeatable indexes and branching filters.",
      "cover": [{"src":"assets/img/inventory_audit_cover.jpg","alt":"Inventory Audit"}],
      "tags": ["SQL Development","Audit","Inventory"],
      "tech_stack": ["T-SQL","SQL Agent","Indexing"],
      "role": "Data Engineer",
      "links": {
        "repo":"sql/inventory_audit.sql",
        "case_study":"assets/pdfjs/web/viewer.html?file=../../pdf/inventory_audit_notes.pdf"
      },
      "metrics": [{"label":"Tables","value":"12"},{"label":"Indexes","value":"27"},{"label":"Runtime","value":"< 6m"}],
      "highlights": ["Branching filter paths","Repeatable index strategy","Variance surfacing for Ops"],
      "featured": true
    },
    {
      "id": "product-365-sales",
      "title": "365-Day Product Sales",
      "subtitle": "Rolling 30/90/365 movement and cost for turns",
      "description": "Aggregates rolling movement and cost to feed excess/turns KPIs while isolating returns and enforcing location-type rules.",
      "cover": [{"src":"assets/img/365_sales.jpg","alt":"Sales Coverage"}],
      "tags": ["SQL Development","KPIs","Performance"],
      "tech_stack": ["T-SQL","Window Functions"],
      "role": "Data Engineer",
      "links": {"repo":"sql/product_365_sales.sql"},
      "metrics": [{"label":"Rows/day","value":"40M+"},{"label":"Refresh","value":"Hourly"}],
      "highlights": ["Window functions","Return isolation","Location rules"],
      "featured": true
    },
    {
      "id": "price-matrix-replacement-cost",
      "title": "Price Matrix & Replacement Cost",
      "subtitle": "Unified cost sources and tier logic",
      "description": "Supporting scripts unify cost sources and tier logic to drive margin analytics and downstream contract pricing.",
      "cover": [{"src":"assets/img/price_matrix.jpg","alt":"Price Matrix"}],
      "tags": ["SQL Development","Costing","Margin"],
      "tech_stack": ["T-SQL","ETL"],
      "role": "Data Engineer",
      "links": {"repo":"sql/price_matrix.sql"},
      "metrics": [{"label":"Tiers","value":"7"},{"label":"Latency","value":"< 2m"}],
      "highlights": ["Tier precedence","Margin analytics","Contract pricing feed"],
      "featured": false
    },
    {
      "id": "branch-ledger-feeds",
      "title": "Branch & Ledger Feeds",
      "subtitle": "Dimensions and facts for BI & Finance",
      "description": "Core dimension and fact extracts shaping a governed layer for Power BI and finance reconciliation (A/R, A/P, Inventory).",
      "cover": [{"src":"assets/img/ledger.jpg","alt":"Ledger Feeds"}],
      "tags": ["SQL Development","Operations","Governance"],
      "tech_stack": ["T-SQL","Power BI"],
      "role": "Data Engineer",
      "links": {"repo":"sql/ledger_file.sql"},
      "metrics": [{"label":"Dimensions","value":"12"},{"label":"Facts","value":"9"}],
      "highlights": ["Shared dimensions","BI-ready facts","Recon alignment"],
      "featured": false
    },
    {
      "id": "branch-inventory-foundation",
      "title": "Branch Inventory Foundation",
      "subtitle": "Surrogate keys and indexed attributes",
      "description": "Consolidates product and branch calculation sources; indexes lead time and safety stock attributes for availability and aging analytics.",
      "cover": [{"src":"assets/img/inventory_foundation.jpg","alt":"Inventory Foundation"}],
      "tags": ["SQL Development","Inventory","Performance"],
      "tech_stack": ["T-SQL","Indexing"],
      "role": "Data Engineer",
      "links": {"repo":"sql/product_branch_inventory.sql"},
      "metrics": [{"label":"SLO","value":"p95 < 1.2s"},{"label":"Size","value":"200 GB"}],
      "highlights": ["Consolidated keys","Availability analytics","Aging insights"],
      "featured": false
    },
    {
      "id": "spa-rebate-normalization",
      "title": "SPA & Rebate Normalization",
      "subtitle": "Clean fact for margin reconciliation",
      "description": "Extracts PO and sales linkages, classifies SPA vs SPJ, and materializes a clean rebate fact for variance and eligibility.",
      "cover": [{"src":"assets/img/rebates.jpg","alt":"Rebate Normalization"}],
      "tags": ["SQL Development","Rebates","Margin"],
      "tech_stack": ["T-SQL","Joins"],
      "role": "Data Engineer",
      "links": {"repo":"sql/rebates.sql"},
      "metrics": [{"label":"Link accuracy","value":"99.2%"},{"label":"Records","value":"35M"}],
      "highlights": ["SPA/SPJ classification","Variance surfacing","Eligibility flags"],
      "featured": false
    },
    {
      "id": "tagged-order-variance",
      "title": "Tagged Order Variance",
      "subtitle": "Reconcile sales lines to PO/transfer tags",
      "description": "Reconciles sales lines to PO and transfer tags, flags cost variances, and surfaces broken tag scenarios for correction.",
      "cover": [{"src":"assets/img/tagged_orders.jpg","alt":"Tagged Orders"}],
      "tags": ["SQL Development","Audit","Exceptions"],
      "tech_stack": ["T-SQL"],
      "role": "Data Engineer",
      "links": {"repo":"sql/so_tagged_orders.sql"},
      "metrics": [{"label":"Exceptions/day","value":"~2k"},{"label":"MTTR","value":"< 1d"}],
      "highlights": ["Variance detection","Exception queues","Ops handoff"],
      "featured": false
    },
    {
      "id": "unbilled-ap-exposure",
      "title": "Unbilled AP Exposure",
      "subtitle": "Accrual and payment G/L to UBAP",
      "description": "Produces an unbilled payable ledger combining accrual and payment G/L postings to monitor aging and exceptions before liability surprises.",
      "cover": [{"src":"assets/img/unbilled_ap.jpg","alt":"Unbilled AP"}],
      "tags": ["Finance","Controls","AP"],
      "tech_stack": ["T-SQL"],
      "role": "Data Engineer",
      "links": {"repo":"sql/ap_unbilled.sql"},
      "metrics": [{"label":"Exposure delta","value":"−18%"},{"label":"Alerts","value":"Daily"}],
      "highlights": ["Aging visibility","Pre-invoice signals","Finance alignment"],
      "featured": false
    },
    {
      "id": "covid-workforce-planning",
      "title": "COVID-19 Workforce Planning & Reporting",
      "subtitle": "Productivity vs. hours to inform staffing",
      "description": "Executive dashboard measuring productivity against working hours to manage workforce utilization during the pandemic; contributed to zero layoffs.",
      "cover": [{"src":"assets/img/workforce.jpg","alt":"Workforce Planning"}],
      "tags": ["Operations","Case Study","Power BI","Analytics"],
      "tech_stack": ["SQL","Power BI","SSMS"],
      "role": "Analytics Engineer",
      "links": {"case_study":"assets/pdfjs/web/viewer.html?file=../../pdf/operational_productivity.pdf"},
      "metrics": [{"label":"Teams","value":"6"},{"label":"Dashboards","value":"4"}],
      "highlights": ["Exec-ready visuals","Utilization insights","Schedule optimization"],
      "featured": true
    },
    {
      "id": "lakehouse-synapse-strategy",
      "title": "Lakehouse & Synapse Strategy",
      "subtitle": "ADLS Gen2 + Synapse (serverless/dedicated)",
      "description": "Azure-first lake design with governed zones and shared definitions for BI; cost-aware and reliable.",
      "cover": [{"src":"assets/img/lakehouse.jpg","alt":"Lakehouse"}],
      "tags": ["Architecture","Platform","Governance"],
      "tech_stack": ["ADLS Gen2","Synapse","RBAC/RLS"],
      "role": "Architect",
      "links": {},
      "metrics": [{"label":"Zones","value":"3"},{"label":"Cost ↓","value":"~22%"}],
      "highlights": ["Zone governance","Shared dimensions","Cost control"],
      "featured": false
    },
    {
      "id": "minwage-compliance-dashboard",
      "title": "Minimum Wage Compliance Dashboard",
      "subtitle": "Blending BLS CPI with multi-level wage rules",
      "description": "Power BI dashboard with ratio trends and alerts across federal/state/county/city minimum-wage rules.",
      "cover": [{"src":"assets/img/minwage.jpg","alt":"Minimum Wage Dashboard"}],
      "tags": ["Compliance","Research","Analytics"],
      "tech_stack": ["Power BI","Azure","Python"],
      "role": "Analytics Engineer",
      "links": {},
      "metrics": [{"label":"Jurisdictions","value":"500+"},{"label":"Alert latency","value":"< 1 day"}],
      "highlights": ["CPI overlays","Multi-level rules","Alerting"],
      "featured": true
    }
  ]
  </script>

  <!-- Single, normalized app script (filters default to show all) -->
  <script>
(() => {
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => [...r.querySelectorAll(s)];
  const byId = id => document.getElementById(id);

  // ---------- load data ----------
  const dataEl = byId('projects-data');
  if (!dataEl) { console.error('Missing #projects-data'); return; }

  let projects = [];
  try { projects = JSON.parse(dataEl.textContent.trim()); }
  catch (e) { console.error('Invalid JSON in #projects-data', e); return; }

  // Normalize helper
  const keyify = s => String(s || '')
    .normalize('NFKD')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase()
    .replace(/[^\w]+/g, '-');

  // Precompute normalized key sets on each project
  projects.forEach(p => {
    p._tagKeys  = new Set((p.tags || []).map(keyify));
    p._techKeys = new Set((p.tech_stack || []).map(keyify));
  });

  // ---------- state ----------
  const state = {
    tagKeys: new Set(),
    techKeys: new Set(),
    featuredOnly: false
  };

  // ---------- elements ----------
  const grid = byId('view-grid');
  const emptyState = byId('empty');
  const quickChips = byId('quick-chips');
  const side = { tags: byId('filter-tags'), tech: byId('filter-tech'), featured: byId('filter-featured') };

  // vocab
  const dedupeByKey = (labels) => {
    const map = new Map();
    labels.forEach(lbl => { const k = keyify(lbl); if (!map.has(k)) map.set(k, String(lbl)); });
    return [...map.entries()].map(([key, label]) => ({ key, label }));
  };
  const vocab = {
    tags: dedupeByKey(projects.flatMap(p => p.tags || [])).sort((a,b)=>a.label.localeCompare(b.label)),
    tech: dedupeByKey(projects.flatMap(p => p.tech_stack || [])).sort((a,b)=>a.label.localeCompare(b.label))
  };

  // build UI
  renderFilters();
  renderQuickChips();
  wireInteractions();
  render();

  function renderFilters() {
    side.tags.innerHTML = '';
    vocab.tags.forEach(v => side.tags.appendChild(chip(v.label, v.key, state.tagKeys)));
    side.tech.innerHTML = '';
    vocab.tech.forEach(v => side.tech.appendChild(chip(v.label, v.key, state.techKeys)));
    side.featured.checked = state.featuredOnly;
  }
  function renderQuickChips() {
    const common = ['SQL Development','Architecture','Analytics','Operations','Finance','Compliance']
      .map(label => ({ label, key: keyify(label) }));
    const tagKeySet = new Set(vocab.tags.map(v => v.key));
    quickChips.innerHTML = '';
    common.filter(x => tagKeySet.has(x.key)).forEach(x => quickChips.appendChild(chip(x.label, x.key, state.tagKeys)));
  }
  function chip(label, key, setRef){
    const b = document.createElement('button');
    b.type = 'button'; b.className = 'chip'; b.textContent = label; b.dataset.key = key;
    b.setAttribute('aria-pressed', setRef.has(key) ? 'true' : 'false'); return b;
  }

  function wireInteractions(){
    [[side.tags, state.tagKeys],[side.tech, state.techKeys],[quickChips, state.tagKeys]].forEach(([container, setRef]) => {
      container?.addEventListener('click', (e) => {
        const c = e.target.closest('.chip'); if (!c) return;
        const key = c.dataset.key || keyify(c.textContent);
        setRef.has(key) ? setRef.delete(key) : setRef.add(key);
        syncChipStates(key); render();
      });
    });
    side.featured.addEventListener('change', () => { state.featuredOnly = side.featured.checked; render(); });
    $$('.clear-filters').forEach(btn => btn.addEventListener('click', clearAll));
    byId('btn-clear')?.addEventListener('click', clearAll);
    byId('btn-top')?.addEventListener('click', () => window.scrollTo({ top:0, behavior:'smooth' }));

    // overlay close
    byId('detail-close')?.addEventListener('click', closeOverlay);
    byId('detail-overlay')?.addEventListener('click', (e)=>{ if (e.target.id === 'detail-overlay') closeOverlay(); });
  }
  function clearAll(){ state.tagKeys.clear(); state.techKeys.clear(); state.featuredOnly = false; renderFilters(); renderQuickChips(); render(); }
  function syncChipStates(key){
    const pressed = state.tagKeys.has(key) || state.techKeys.has(key);
    $$('#projects .chips .chip, #quick-chips .chip').forEach(c => {
      const k = c.dataset.key || keyify(c.textContent);
      if (k === key) c.setAttribute('aria-pressed', pressed ? 'true' : 'false');
    });
  }

  // grid render
  function render(){
    const rows = filtered(projects);
    grid.innerHTML = '';
    const g = document.createElement('div'); g.className = 'grid';
    rows.forEach(p => g.appendChild(renderCard(p)));
    grid.appendChild(g);
    emptyState.hidden = rows.length !== 0;
  }
  function filtered(rows){
    return rows.filter(p => {
      if (state.featuredOnly && !p.featured) return false;
      if (state.tagKeys.size && !isSubset(state.tagKeys, p._tagKeys)) return false;
      if (state.techKeys.size && !isSubset(state.techKeys, p._techKeys)) return false;
      return true;
    });
  }
  function isSubset(needles, hayset){ for (const n of needles) if (!hayset.has(n)) return false; return true; }

  function renderCard(p){
    const card = div('card'); card.setAttribute('data-id', p.id);
    const img = document.createElement('img');
    img.className = 'card-cover'; img.loading='lazy';
    img.alt = p?.cover?.[0]?.alt || p.title; img.src = p?.cover?.[0]?.src || 'assets/img/placeholder.jpg';
    const body = div('card-body');
    if (p.role) body.append(span('role-badge', ' ' + p.role));
    body.append(
      h('h3','card-title', p.title),
      p.subtitle ? pEl('card-sub', p.subtitle) : div('card-sub',''),
      p.description ? pEl('card-desc', p.description) : div('card-desc',''),
      (() => { const meta = div('card-meta'); meta.append(metaTags(p.tech_stack||[])); return meta; })(),
      (() => { const row = div(''); (p.metrics||[]).slice(0,2).forEach(m => row.appendChild(span('metric-chip', (m.label||'')+': '+(m.value||'')))); return row; })(),
      (() => {
        const a = div('card-actions');
        a.append(btn('View', () => openOverlay(p)));
        if (p.links?.case_study) a.append(linkBtn('Case study', p.links.case_study));
        if (p.links?.repo) a.append(linkBtn('Repo', p.links.repo));
        return a;
      })()
    );
    card.append(img, body);
    card.addEventListener('click', (e) => { if (!e.target.closest('a,button')) openOverlay(p); });
    return card;
  }
  function metaTags(items){ const row = div('meta-tags'); items.forEach(t => row.appendChild(span('meta-tag', t))); return row; }

  // ---------- overlay logic ----------
  const overlay = byId('detail-overlay');
  const el = {
    kicker: byId('detail-kicker'),
    title: byId('detail-title'),
    stage: byId('wb-stage'),
    tabs: byId('wb-tabs'),
    sub: byId('d-sub'),
    desc: byId('d-desc'),
    role: byId('d-role'),
    tags: byId('d-tags'),
    tech: byId('d-tech'),
    highlights: byId('d-highlights'),
    metrics: byId('d-metrics'),
    links: byId('d-links'),
  };

  function openOverlay(p){
    // header
    el.kicker.textContent = (p.tags||[]).slice(0,1).join(' • ');
    el.title.textContent = p.title;
    // right column
    el.sub.textContent = p.subtitle || '';
    el.desc.textContent = p.description || '';
    el.role.innerHTML = ''; if (p.role) el.role.appendChild(span('pill', p.role));
    el.tech.innerHTML = ''; (p.tech_stack||[]).forEach(t => el.tech.appendChild(span('pill', t)));
    el.tags.innerHTML = ''; (p.tags||[]).forEach(t => el.tags.appendChild(span('pill', t)));
    el.highlights.innerHTML = ''; (p.highlights||[]).forEach(hh => el.highlights.appendChild(li(hh)));
    el.metrics.innerHTML = ''; (p.metrics||[]).forEach(m => { const c=div('metric'); c.append(div('metric-label', m.label), div('metric-value', m.value)); el.metrics.appendChild(c); });
    el.links.innerHTML = '';
    if (p.links?.demo) el.links.appendChild(linkBtn('Open demo', p.links.demo));
    if (p.links?.repo) el.links.appendChild(linkBtn('Open repo', p.links.repo));
    if (p.links?.case_study) el.links.appendChild(linkBtn('Open PDF', p.links.case_study));

    // left workbench — tabs: PDF / SQL (only if present)
    el.tabs.innerHTML = '';
    el.stage.innerHTML = '';

    const tabs = [];
    if (p.links?.case_study) tabs.push({id:'pdf', label:'PDF'});
    if (p.links?.repo) tabs.push({id:'sql', label:'SQL'});
    if (!tabs.length){
      tabs.push({id:'cover', label:'Preview'});
    }
    tabs.forEach((t, i) => {
      const b = document.createElement('button');
      b.className = 'tab';
      b.textContent = t.label;
      b.dataset.id = t.id;
      b.setAttribute('aria-selected', i === 0 ? 'true' : 'false');
      b.addEventListener('click', () => { setTab(t.id); });
      el.tabs.appendChild(b);
    });
    setTab(tabs[0].id, p);

    overlay?.setAttribute('aria-hidden','false');
  }

  function setTab(id, pOverride){
    // active state
    $$('#wb-tabs .tab').forEach(b => b.setAttribute('aria-selected', b.dataset.id === id ? 'true' : 'false'));
    // stage content
    el.stage.innerHTML = '';
    const p = pOverride || projects.find(pp => pp.title === byId('detail-title').textContent);
    if (!p) return;

    if (id === 'pdf' && p.links?.case_study){
      const frame = document.createElement('iframe');
      frame.src = p.links.case_study;  // already points at pdfjs viewer
      el.stage.appendChild(frame);
    } else if (id === 'sql' && p.links?.repo){
      const pre = document.createElement('pre'); pre.className = 'code';
      const code = document.createElement('code'); code.className = 'language-sql'; code.textContent = 'Loading SQL…';
      pre.appendChild(code); el.stage.appendChild(pre);
      // attempt to fetch SQL text (same-origin)
      fetch(p.links.repo, {cache:'no-store'}).then(r => r.ok ? r.text() : Promise.reject(r.status)).then(txt => {
        code.textContent = txt; if (window.hljs) window.hljs.highlightElement(code);
      }).catch(()=>{
        code.textContent = 'Could not load SQL file. Use "Open repo" to view it.';
      });
    } else {
      // fallback to cover image
      const img = document.createElement('img');
      img.alt = p?.cover?.[0]?.alt || p.title;
      img.src = p?.cover?.[0]?.src || 'assets/img/placeholder.jpg';
      img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      el.stage.appendChild(img);
    }
  }

  function closeOverlay(){ byId('detail-overlay')?.setAttribute('aria-hidden','true'); }

  // tiny DOM helpers
  function div(cls, text){ const n=document.createElement('div'); if (cls) n.className=cls; if (text!==undefined) n.textContent=text; return n; }
  function span(cls, text){ const n=document.createElement('span'); if (cls) n.className=cls; n.textContent=text; return n; }
  function h(tag, cls, text){ const n=document.createElement(tag); if (cls) n.className=cls; n.textContent=text; return n; }
  function pEl(cls, text){ const n=document.createElement('p'); if (cls) n.className=cls; n.textContent=text; return n; }
  function li(text){ const n=document.createElement('li'); n.textContent=text; return n; }

  // Footer year + mobile nav
  document.addEventListener('DOMContentLoaded', () => {
    const y = document.getElementById('year');
    if (y) y.textContent = new Date().getFullYear();
    const toggle = document.querySelector('.nav-toggle');
    const nav = document.getElementById('site-nav');
    if (toggle && nav) {
      toggle.addEventListener('click', () => {
        const open = nav.classList.toggle('open');
        toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      });
    }
    if (window.hljs) window.hljs.highlightAll?.();
  });
})();
  </script>

</body>
</html>
